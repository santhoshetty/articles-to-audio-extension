(()=>{var I=Object.defineProperty;var m=Object.getOwnPropertySymbols;var T=Object.prototype.hasOwnProperty,x=Object.prototype.propertyIsEnumerable;var h=(e,r,t)=>r in e?I(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t,f=(e,r)=>{for(var t in r||(r={}))T.call(r,t)&&h(e,t,r[t]);if(m)for(var t of m(r))x.call(r,t)&&h(e,t,r[t]);return e};var C="ArticleToAudioDB";var d={ARTICLES:"articles",AUDIO:"audio",SETTINGS:"settings"};function O(){return new Promise((e,r)=>{let t=indexedDB.open(C,2);t.onerror=n=>{console.error("Database error:",n.target.error),r(n.target.error)},t.onsuccess=n=>{let o=n.target.result;console.log("Database opened successfully"),e(o)},t.onupgradeneeded=n=>{let o=n.target.result,a=n.oldVersion;if(console.log(`Database upgrade needed from version ${a} to 2`),a<1){if(!o.objectStoreNames.contains(d.ARTICLES)){let s=o.createObjectStore(d.ARTICLES,{keyPath:"id",autoIncrement:!0});s.createIndex("url","url",{unique:!0}),s.createIndex("title","title",{unique:!1}),s.createIndex("dateAdded","dateAdded",{unique:!1}),console.log("Articles store created")}if(!o.objectStoreNames.contains(d.AUDIO)){let s=o.createObjectStore(d.AUDIO,{keyPath:"id",autoIncrement:!0});s.createIndex("articleId","articleId",{unique:!1}),s.createIndex("type","type",{unique:!1}),s.createIndex("dateCreated","dateCreated",{unique:!1}),console.log("Audio store created")}if(!o.objectStoreNames.contains(d.SETTINGS)){let s=o.createObjectStore(d.SETTINGS,{keyPath:"key"});console.log("Settings store created")}}if(a<2&&(console.log("Upgrading to version 2: Removing URL uniqueness constraint"),o.objectStoreNames.contains(d.ARTICLES))){let s=n.target.transaction.objectStore(d.ARTICLES);s.indexNames.contains("url")&&s.deleteIndex("url"),s.createIndex("url","url",{unique:!1}),console.log("URL index updated to non-unique")}}})}async function p(){return await O()}async function w(e){let r=await p();return new Promise((t,n)=>{let o=r.transaction([d.ARTICLES],"readwrite"),a=o.objectStore(d.ARTICLES);e.dateAdded||(e.dateAdded=new Date().toISOString()),e.hasOwnProperty("url")||(e.url=null);let s=a.add(e);s.onsuccess=i=>{console.log("Article saved successfully with ID:",i.target.result),t(i.target.result)},s.onerror=i=>{if(console.error("Error saving article:",i.target.error),i.target.error.name==="ConstraintError"){console.log("Attempting to save with a modified URL to avoid uniqueness constraints");let c=new Date().getTime();e.url?e.url=`${e.url}#${c}`:e.url=`generated-url-${c}`;let u=a.add(e);u.onsuccess=l=>{console.log("Article saved with modified URL, ID:",l.target.result),t(l.target.result)},u.onerror=l=>{console.error("Failed to save article with modified URL:",l.target.error),n(l.target.error)}}else n(i.target.error)},o.oncomplete=()=>{r.close()}})}async function y(e){let r=await p();return new Promise((t,n)=>{let o=r.transaction([d.SETTINGS],"readonly"),s=o.objectStore(d.SETTINGS).get(e);s.onsuccess=i=>{let c=i.target.result;t(c?c.value:null)},s.onerror=i=>{console.error(`Error getting setting "${e}":`,i.target.error),n(i.target.error)},o.oncomplete=()=>{r.close()}})}async function S(e,r){var o;let t=await y("openai_api_key");if(!t)throw new Error("OpenAI API key not found. Please add it in the extension settings.");let n=await fetch(`https://api.openai.com/v1/${e}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(r)});if(!n.ok){let a=await n.json().catch(()=>({error:"Unknown error"}));throw new Error(`OpenAI API error (${n.status}): ${((o=a.error)==null?void 0:o.message)||JSON.stringify(a)}`)}return await n.json()}async function A(e){return(await S("chat/completions",{model:"gpt-3.5-turbo",messages:[{role:"system",content:`Summarize the following article concisely while maintaining key details, 
        covering the main topic, essential facts, important arguments, and any conclusions. 
        Highlight the who, what, when, where, why, and how (if applicable). Retain the 
        original tone\u2014whether informative, analytical, or opinion-based\u2014and include any 
        significant statistics, quotes, or expert opinions mentioned. Ensure clarity, 
        coherence, and neutrality (unless it is an opinion piece, in which case, reflect 
        the stance of the author accurately). If there are action points or takeaways, include 
        them in bullet points.`},{role:"user",content:e}],max_tokens:500,temperature:.7})).choices[0].message.content.trim()}async function b(e){return(await S("chat/completions",{model:"gpt-3.5-turbo",messages:[{role:"system",content:"Generate a concise, engaging title (maximum 10 words) for this article. Return only the title without quotes or additional text."},{role:"user",content:e}],max_tokens:50,temperature:.7})).choices[0].message.content.trim()}var E=!1;chrome.runtime.onInstalled.addListener(()=>{console.log("Extension installed or updated"),g()});chrome.runtime.onStartup.addListener(()=>{console.log("Browser started, initializing extension"),g()});chrome.runtime.onMessage.addListener((e,r)=>{var t;if(e.action==="CONTENT_SCRIPT_READY")return console.log("Content script ready in tab:",(t=r.tab)==null?void 0:t.id),!1});async function g(){if(!E){console.log("Initializing extension");try{chrome.runtime.onMessage.addListener(k),E=!0,console.log("Extension initialized successfully")}catch(e){console.error("Error initializing extension:",e)}}}function k(e,r,t){if(console.log("Background received message:",e.action||e.type),e.action==="SAVE_ARTICLE")return R(e.payload).then(n=>t(n)).catch(n=>{console.error("Error saving article:",n),t({success:!1,error:n.message})}),!0;if(e.action==="EXTRACT_ARTICLE")return P(r.tab).then(n=>t(n)).catch(n=>{console.error("Error extracting article:",n),t({success:!1,error:n.message})}),!0;if(e.action==="EXTRACT_ARTICLE_FALLBACK"){let n=e.tabId;return chrome.tabs.get(n).then(o=>L(o)).then(o=>t(o)).catch(o=>{console.error("Error in fallback extraction:",o),t({success:!1,error:o.message})}),!0}return!1}async function P(e){if(!e||!e.id)throw new Error("No active tab found");try{if(console.log(`Attempting to extract article from tab ${e.id} (${e.url})`),["chrome://","chrome-extension://","about:","file:","chrome.google.com","addons.mozilla.org"].some(a=>e.url.startsWith(a)))throw new Error(`Cannot extract from ${e.url}. Please try with a regular web page.`);try{await chrome.scripting.executeScript({target:{tabId:e.id},files:["contentScript.js"]}),console.log("Content script injection successful")}catch(a){if(console.error("Content script injection error:",a),a.message.includes("Cannot access"))throw new Error("Cannot access page content. Please try with a regular web page.")}let t=new Promise((a,s)=>setTimeout(()=>s(new Error("Article extraction timed out")),1e4));try{let a=chrome.tabs.sendMessage(e.id,{action:"PING"}),s=await Promise.race([a,t]).catch(i=>(console.warn("Content script ping failed:",i),null));!s||s.status!=="PONG"?console.warn("Content script not responding to ping properly:",s):console.log("Content script is responsive in tab",e.id)}catch(a){console.warn("Error checking content script:",a)}let n=chrome.tabs.sendMessage(e.id,{action:"EXTRACT_ARTICLE"}),o=await Promise.race([n,t]);if(!o)throw new Error("No response from content script");if(o.error)throw new Error(o.error);if(!o.text||o.text.length<100)throw new Error("Extracted content is too short or empty");return console.log("Article extraction successful:",{title:o.title,textLength:o.text.length}),o}catch(r){throw console.error("Error in article extraction:",r),new Error("Failed to extract article content: "+r.message)}}async function L(e){if(!e||!e.id)throw new Error("No valid tab provided for fallback extraction");console.log(`Attempting fallback extraction from tab ${e.id}`);try{let[r]=await chrome.scripting.executeScript({target:{tabId:e.id},func:()=>{function n(){try{let o=function(c){return c.replace(/\s+/g," ").trim()},a=document.title||"",s="",i=["article","main",'[role="main"]',".article",".post",".content","#content",".main-content",".article-content",".post-content"];for(let c of i){let u=document.querySelector(c);if(u){let l=u.innerText;if(l&&l.length>200){s=l;break}}}if(!s||s.length<200){let c=Array.from(document.querySelectorAll("p")).filter(u=>u.innerText.length>30).map(u=>u.innerText.trim()).join(`

`);c.length>200&&(s=c)}if(!s||s.length<200){let c=document.body.cloneNode(!0);c.querySelectorAll("nav, header, footer, script, style, iframe, .nav, .menu, .header, .footer, .sidebar, .comments, aside").forEach(l=>l.remove()),s=c.innerText}return{title:a,text:s,url:window.location.href}}catch(o){return{error:o.message||"Unknown error in extraction script"}}}return n()}});if(!r||r.error)throw new Error((r==null?void 0:r.error)||"Failed to extract content from page");let t=r.result;if(!t||!t.text||t.text.length<100)throw new Error("Extracted content is too short or empty from fallback method");return console.log("Fallback extraction successful:",{title:t.title,textLength:t.text.length}),t}catch(r){throw console.error("Error in fallback extraction:",r),new Error("Failed to extract content using fallback method: "+r.message)}}async function R(e){try{if(console.log("Saving article locally:",{title:e.title,url:e.url,contentLength:e.text?e.text.length:0}),!e.text||e.text.length<100)throw new Error("Article content is too short or missing");let r=[/function\(\s*\)\s*{\s*['"]use strict['"]/,/new [A-Za-z]+\([a-z],[a-z],[a-z]\){/,/\([a-z],(?:\[[a-z]\]|\{[a-z]\}),[a-z]\)=>/,/var [a-zA-Z]{1,2}=function\(/,/var [a-zA-Z]{1,2}=/],t=.1,o=(e.text.match(/[{}();=><[\]]/g)||[]).length/e.text.length,a=r.some(l=>l.test(e.text)),s=o>t;if(a&&s)throw console.error("Detected minified JavaScript instead of article content"),new Error("Cannot save: Content appears to be JavaScript code rather than an article");if(!e.title){console.log("Generating title for article content");try{e.title=await b(e.text)}catch(l){console.error("Error generating title:",l),e.title="Untitled Article"}}if(!e.summary&&e.text){console.log("Generating summary for article content");try{e.summary=await A(e.text)}catch(l){console.error("Error generating summary:",l)}}let i=e.url;if(!i)try{i=await j()}catch(l){console.warn("Could not get current tab URL:",l),i=`article-${new Date().getTime()}`}let c={title:e.title,content:e.text,summary:e.summary,url:i,dateAdded:e.date||new Date().toISOString()},u=await w(c);return console.log("Article saved successfully to local storage:",{article_id:u,title:c.title}),{success:!0,article:f({id:u},c)}}catch(r){return console.error("Error saving article:",r),{success:!1,error:r.message}}}async function j(){let e=await chrome.tabs.query({active:!0,currentWindow:!0});return e&&e.length>0?e[0].url:""}g();})();
