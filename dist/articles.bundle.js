(()=>{var We=Object.defineProperty,Je=Object.defineProperties;var Ke=Object.getOwnPropertyDescriptors;var xe=Object.getOwnPropertySymbols;var Xe=Object.prototype.hasOwnProperty,Qe=Object.prototype.propertyIsEnumerable;var Be=(e,t,o)=>t in e?We(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,V=(e,t)=>{for(var o in t||(t={}))Xe.call(t,o)&&Be(e,o,t[o]);if(xe)for(var o of xe(t))Qe.call(t,o)&&Be(e,o,t[o]);return e},Q=(e,t)=>Je(e,Ke(t));var z="ArticleToAudioDB";var A={ARTICLES:"articles",AUDIO:"audio",SETTINGS:"settings"};function Ze(){return new Promise((e,t)=>{let o=indexedDB.open(z,2);o.onerror=n=>{console.error("Database error:",n.target.error),t(n.target.error)},o.onsuccess=n=>{let a=n.target.result;console.log("Database opened successfully"),e(a)},o.onupgradeneeded=n=>{let a=n.target.result,i=n.oldVersion;if(console.log(`Database upgrade needed from version ${i} to 2`),i<1){if(!a.objectStoreNames.contains(A.ARTICLES)){let r=a.createObjectStore(A.ARTICLES,{keyPath:"id",autoIncrement:!0});r.createIndex("url","url",{unique:!0}),r.createIndex("title","title",{unique:!1}),r.createIndex("dateAdded","dateAdded",{unique:!1}),console.log("Articles store created")}if(!a.objectStoreNames.contains(A.AUDIO)){let r=a.createObjectStore(A.AUDIO,{keyPath:"id",autoIncrement:!0});r.createIndex("articleId","articleId",{unique:!1}),r.createIndex("type","type",{unique:!1}),r.createIndex("dateCreated","dateCreated",{unique:!1}),console.log("Audio store created")}if(!a.objectStoreNames.contains(A.SETTINGS)){let r=a.createObjectStore(A.SETTINGS,{keyPath:"key"});console.log("Settings store created")}}if(i<2&&(console.log("Upgrading to version 2: Removing URL uniqueness constraint"),a.objectStoreNames.contains(A.ARTICLES))){let r=n.target.transaction.objectStore(A.ARTICLES);r.indexNames.contains("url")&&r.deleteIndex("url"),r.createIndex("url","url",{unique:!1}),console.log("URL index updated to non-unique")}}})}async function R(){return await Ze()}async function Oe(e){let t=await R();return new Promise((o,n)=>{let a=t.transaction([A.ARTICLES],"readwrite"),i=a.objectStore(A.ARTICLES);e.dateUpdated=new Date().toISOString();let r=i.put(e);r.onsuccess=()=>{console.log("Article updated successfully"),o(!0)},r.onerror=s=>{console.error("Error updating article:",s.target.error),n(s.target.error)},a.oncomplete=()=>{t.close()}})}async function Te(){let e=await R();return new Promise((t,o)=>{let n=e.transaction([A.ARTICLES],"readonly"),i=n.objectStore(A.ARTICLES).getAll();i.onsuccess=r=>{t(r.target.result)},i.onerror=r=>{console.error("Error getting articles:",r.target.error),o(r.target.error)},n.oncomplete=()=>{e.close()}})}async function Z(e){let t=await R();return new Promise((o,n)=>{let a=t.transaction([A.ARTICLES],"readonly"),r=a.objectStore(A.ARTICLES).get(e);r.onsuccess=s=>{o(s.target.result)},r.onerror=s=>{console.error("Error getting article:",s.target.error),n(s.target.error)},a.oncomplete=()=>{t.close()}})}async function ie(e){let t=await R();return new Promise((o,n)=>{let a=t.transaction([A.ARTICLES],"readwrite"),r=a.objectStore(A.ARTICLES).delete(e);r.onsuccess=async()=>{try{await et(e),o(!0)}catch(s){console.error("Error deleting associated audio:",s),n(s)}},r.onerror=s=>{console.error("Error deleting article:",s.target.error),n(s.target.error)},a.oncomplete=()=>{t.close()}})}async function ce(e){let t=await R();return new Promise((o,n)=>{let a=t.transaction([A.AUDIO],"readwrite"),i=a.objectStore(A.AUDIO);e.dateCreated||(e.dateCreated=new Date().toISOString());let r=i.add(e);r.onsuccess=s=>{console.log("Audio saved successfully with ID:",s.target.result),o(s.target.result)},r.onerror=s=>{console.error("Error saving audio:",s.target.error),n(s.target.error)},a.oncomplete=()=>{t.close()}})}async function $e(e){let t=await R();return new Promise((o,n)=>{let a=t.transaction([A.AUDIO],"readonly"),s=a.objectStore(A.AUDIO).index("articleId").getAll(e);s.onsuccess=c=>{o(c.target.result)},s.onerror=c=>{console.error("Error getting audio:",c.target.error),n(c.target.error)},a.oncomplete=()=>{t.close()}})}async function et(e){let t=await R();return new Promise((o,n)=>{let a=t.transaction([A.AUDIO],"readwrite"),i=a.objectStore(A.AUDIO),s=i.index("articleId").getAllKeys(e);s.onsuccess=c=>{let l=c.target.result;if(l.length===0){o(!0);return}let u=0;l.forEach(g=>{let d=i.delete(g);d.onsuccess=()=>{u++,u===l.length&&o(!0)},d.onerror=m=>{console.error("Error deleting audio:",m.target.error),n(m.target.error)}})},s.onerror=c=>{console.error("Error getting audio keys:",c.target.error),n(c.target.error)},a.oncomplete=()=>{t.close()}})}async function le(e,t){let o=await R();return new Promise((n,a)=>{let i=o.transaction([A.SETTINGS],"readwrite"),s=i.objectStore(A.SETTINGS).put({key:e,value:t});s.onsuccess=()=>{console.log(`Setting "${e}" saved successfully`),n(!0)},s.onerror=c=>{console.error(`Error saving setting "${e}":`,c.target.error),a(c.target.error)},i.oncomplete=()=>{o.close()}})}async function C(e){let t=await R();return new Promise((o,n)=>{let a=t.transaction([A.SETTINGS],"readonly"),r=a.objectStore(A.SETTINGS).get(e);r.onsuccess=s=>{let c=s.target.result;o(c?c.value:null)},r.onerror=s=>{console.error(`Error getting setting "${e}":`,s.target.error),n(s.target.error)},a.oncomplete=()=>{t.close()}})}function Ce(e,t={}){let o=[],n=e.split(`
`);for(let a=0;a<n.length;a++){let i=n[a].trim();if(!i)continue;let r=i.match(/^(HOST|CO-HOST|Alice|Bob):\s*(.*)/i);if(r){let s=r[1].trim().toUpperCase(),c=r[2].trim();if(c){let l=tt(`${s}: ${c}`,4e3);for(let u of l){let g=u.match(/^(HOST|CO-HOST|Alice|Bob):\s*(.*)/i);g&&o.push({speaker:g[1].trim().toUpperCase(),text:g[2].trim(),settings:t})}}}else if(o.length>0){let s=o[o.length-1];(s.text+" "+i).length>4e3?o.push({speaker:s.speaker,text:i,settings:t}):s.text+=" "+i}else o.push({speaker:"HOST",text:i,settings:t})}return o}function tt(e,t=4e3){if(e.length<=t)return[e];let o=[],n="",a=e.match(/^(HOST|CO-HOST|Alice|Bob):/i)[1],r=e.replace(/^(HOST|CO-HOST|Alice|Bob):\s*/i,"").split(new RegExp("(?<=\\.\\s+)"));for(let s of r)if(n.length+s.length>t)if(n.length>0&&(o.push(`${a}: ${n}`),n=""),s.length>t){let c=s.split(/\s+/),l="";for(let u of c)l.length+u.length+1>t?(o.push(`${a}: ${l}`),l=u):l+=(l?" ":"")+u;l&&(n=l)}else n=s;else n+=s;return n&&o.push(`${a}: ${n}`),o}function ke(e,t,o){let n="HOST: "+e+`

`;for(let a=0;a<t.length;a++)n+=`
--- ARTICLE ${a+1} ---

`,n+=t[a]+`

`;return n+=`
--- CONCLUSION ---

`,n+="HOST: "+o,n}function Le(e,t){let o=t.hostNames.HOST,n=t.hostNames["CO-HOST"];return`You are two podcast hosts, ${o} and ${n}.

Create ONLY the introduction section for a podcast where two hosts engage in a dynamic 
and informative conversation about multiple articles. The introduction should be approximately 1 minute long.

Here are the titles of all articles that will be discussed:
${e.join(`
`)}

The introduction should include:
- ${o} greeting listeners and introducing ${n}.
- Brief overview of the episode's topic and its relevance.
- Mention that today you'll be discussing ALL of these topics: ${e.join(", ")}
- Create excitement about the full range of articles being covered in this episode.
- Indicate that this will be a longer, in-depth episode with substantial time devoted to each topic.

DO NOT start discussing any specific article yet - this is ONLY the introduction.

${de()}

${ue(o,n)}

${ge(o,n)}`}function Pe(e,t){let o=t.hostNames.HOST,n=t.hostNames["CO-HOST"];return`You are two podcast hosts, ${o} and ${n}.

You are in the middle of a podcast episode where you're discussing multiple articles.
You've already introduced the podcast and now need to create a focused discussion about this specific article:

Title: ${e.title}
${e.summary||e.content}

${ot(o,n)}

IMPORTANT:
- DO NOT create an introduction for the podcast - you're already in the middle of the episode.
- DO NOT include any conclusion for the overall podcast.
- DO NOT reference that this is "the first article" or "the next article" or use any numbering.
- If this isn't the first article, start with a natural transition from a previous topic.
- CRITICAL: Your response MUST contain enough detailed content to fill AT LEAST 3.5 minutes of speaking time.
- Each section should be comprehensive and in-depth - be thorough in your analysis and discussion.
- Include substantial dialogue for each point - aim for 2-3 exchanges between hosts per subtopic.
- Remember that spoken content takes longer than reading - aim for approximately 525-550 words minimum.
- The final output should feel like a complete, substantive segment that could stand on its own.
- Addressing the opposite host by name is not required, but feel free to do so if it makes sense in the context of the discussion. But lean towards not using it.
- Include things like "Hmm", shock responses, and other natural human reactions to the topics WHERE APPLICABLE ONLY.

${de()}

${ue(o,n)}

${ge(o,n)}`}function De(e,t){let o=t.hostNames.HOST,n=t.hostNames["CO-HOST"];return`You are two podcast hosts, ${o} and ${n}.

Create ONLY the conclusion section for a podcast where you've just finished discussing these articles:
${e.join(`
`)}

The conclusion should be approximately 1 minute long and include:
- Hosts summarizing key takeaways from the discussions.
- Encouragement for listeners to reflect on the topics or engage further.
- Thanking the audience for listening and mentioning any future episodes.

This is ONLY the conclusion - assume all articles have already been thoroughly discussed.

${de()}

${ue(o,n)}

${ge(o,n)}`}function ot(e,t){return`Create a focused discussion about this specific article that will last for at least 3.5 minutes:
  - Definition and Background (45-60 seconds):
    - ${e} defines the topic and provides historical context.
    - ${t} adds interesting facts or anecdotes related to the topic.
    - Include sufficient detail to properly introduce the topic to listeners.
    - Provide at least 3-4 exchanges between hosts in this section.
  
  - Current Relevance and Applications (60-75 seconds):
    - Both hosts discuss how the topic applies in today's world.
    - Include real-world examples, case studies, or recent news.
    - Explore multiple areas where this topic has current relevance and impact.
    - This should be your most detailed section with at least 4-5 exchanges between hosts.
  
  - Challenges and Controversies (45-60 seconds):
    - Hosts explore any debates or challenges associated with the topic.
    - Present multiple viewpoints to provide a balanced perspective.
    - Discuss potential solutions or approaches to these challenges.
    - Include at least 3-4 exchanges between hosts in this section.
  
  - Future Outlook (30-45 seconds):
    - Hosts speculate on the future developments related to the topic.
    - Discuss potential innovations or changes on the horizon.
    - Consider how this might affect listeners or society as a whole.
    - Include at least 2-3 exchanges between hosts to wrap up the discussion.
  
  IMPORTANT: 
  - The discussion for this article should try to be 3.5 minutes in total. Ensure sufficient depth and detail in each section to meet this time requirement.
  - DO NOT address the opposite speaker by name in every line. Only include it rarely. Lean towards not using it.`}function de(){return`Tone and Style:
  - Conversational and engaging, as if speaking directly to the listener.
  - Use inclusive language to foster a sense of community.
  - Incorporate light humor or personal anecdotes where appropriate to humanize the discussion.`}function ue(e,t){return`Additional Guidelines:
  - Ensure a balanced exchange between both hosts, allowing each to contribute equally.
  - Use clear and concise language, avoiding jargon unless it's explained.
  - Aim for smooth transitions between topics to maintain listener interest.
  - IMPORTANT: DO NOT use terms like "Segment 1" or "Section 2" in the actual dialogue.
  - Consider the use of rhetorical questions to engage the audience and provoke thought.
  - ALWAYS refer to the hosts by their actual names (${e} and ${t}), not as "Host 1" or "Host 2".`}function ge(e,t){return`Format it like a real dialogue:
${e}: ...
${t}: ...
${e}: ...
${t}: ...
Continue this structure with natural conversation flow.`}async function ee(e,t,o=null){let n=new Promise((a,i)=>{let r=setTimeout(()=>{clearTimeout(r),i(new Error(`Operation timed out after ${t/1e3} seconds`))},t);o&&o.addEventListener("abort",()=>{clearTimeout(r),i(new Error("Operation was cancelled"))},{once:!0})});return Promise.race([e(),n])}function G(e){if(typeof process<"u"&&process.memoryUsage){let t=process.memoryUsage();console.log(`Memory Usage (${e}):
    RSS: ${N(t.rss)} (Resident Set Size)
    Heap Total: ${N(t.heapTotal)}
    Heap Used: ${N(t.heapUsed)}
    External: ${N(t.external)}
    ArrayBuffers: ${N(t.arrayBuffers||0)}`)}else console.log("Memory usage logging not available")}function N(e){if(e===0)return"0 Bytes";let t=1024,o=["Bytes","KB","MB","GB","TB"],n=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,n)).toFixed(2))+" "+o[n]}function te(e){return Math.round(e/(16*1024))}function oe(e){let t=Math.floor(e/60),o=Math.floor(e%60);return`${t}:${o.toString().padStart(2,"0")}`}async function He(e,t={},o=()=>{},n=null){let a=n||new AbortController,i=a.signal,r={voiceMap:{HOST:"onyx","CO-HOST":"alloy"},hostNames:{HOST:"Alex","CO-HOST":"Jordan"},title:"Generated Podcast",includeIntroduction:!0,includeConclusion:!0,model:"gpt-3.5-turbo",maxTokens:4096,temperature:.7,timeoutSeconds:60},s=V(V({},r),t);try{if(i.aborted)throw new Error("Operation was cancelled");o({stage:"loading",message:"Loading articles...",progress:5});let c=[];for(let h of e){if(i.aborted)throw new Error("Operation was cancelled");let p=await Z(h);if(!p)throw new Error(`Article with ID ${h} not found`);c.push(p)}(!s.title||s.title===r.title)&&(o({stage:"title",message:"Generating podcast title...",progress:10}),s.title=`Podcast: ${c.map(h=>h.title).join(", ")}`.substring(0,100));let l=await C("openai_api_key");if(!l)throw new Error("OpenAI API key not found in settings");let u="";if(s.includeIntroduction){if(i.aborted)throw new Error("Operation was cancelled");o({stage:"introduction",message:"Generating introduction...",progress:15}),u=await nt(c,l,s,a)}let g=[];for(let h=0;h<c.length;h++){if(i.aborted)throw new Error("Operation was cancelled");let p=20+Math.round(h/c.length*30);o({stage:"discussion",message:`Generating discussion for article ${h+1}/${c.length}...`,progress:p});let S=await rt(c[h],l,s,a);g.push(S),c[h].podcastScript||await Oe(Q(V({},c[h]),{podcastScript:S}))}let d="";if(s.includeConclusion){if(i.aborted)throw new Error("Operation was cancelled");o({stage:"conclusion",message:"Generating conclusion...",progress:55}),d=await st(c,l,s,a)}if(i.aborted)throw new Error("Operation was cancelled");o({stage:"script",message:"Assembling podcast script...",progress:60});let m=ke(u,g,d),b=Ce(m,s);return{title:s.title,articleIds:e,script:m,lines:b,settings:s}}catch(c){throw i.aborted?(console.log("Podcast script generation was cancelled"),o({stage:"cancelled",message:"Operation cancelled",progress:0})):(console.error("Error generating podcast script:",c),o({stage:"error",message:c.message,error:c})),c}}async function nt(e,t,o,n=null){let i=(n||new AbortController).signal,r=e.map(l=>l.title);console.log("Generating introduction...");let s=Le(r,o),c={model:o.model,messages:[{role:"system",content:s}],max_tokens:o.maxTokens,temperature:o.temperature};try{if(i.aborted)throw new Error("Operation was cancelled");console.log(`[${new Date().toISOString()}] Starting OpenAI API call for introduction`);let l=await ee(async()=>{let g=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(c),signal:i});if(!g.ok){let d=await g.json();throw new Error(`OpenAI API error: ${g.status} - ${JSON.stringify(d)}`)}return await g.json()},o.timeoutSeconds*1e3,i);console.log(`[${new Date().toISOString()}] Completed OpenAI API call for introduction`);let u=l.choices[0].message.content.trim();return console.log("Introduction generated"),u}catch(l){throw i.aborted?(console.log("Introduction generation was cancelled"),new Error("Operation was cancelled")):(console.error(`Error generating introduction: ${l.message}`),l)}}async function rt(e,t,o,n=null){let i=(n||new AbortController).signal;console.log(`Generating discussion for article: ${e.title}`);let r=Pe(e,o),s={model:o.model,messages:[{role:"system",content:r}],max_tokens:o.maxTokens,temperature:o.temperature};try{if(i.aborted)throw new Error("Operation was cancelled");console.log(`[${new Date().toISOString()}] Starting OpenAI API call for article discussion`);let c=await ee(async()=>{let d=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(s),signal:i});if(!d.ok){let m=await d.json();throw new Error(`OpenAI API error: ${d.status} - ${JSON.stringify(m)}`)}return await d.json()},o.timeoutSeconds*1e3,i);console.log(`[${new Date().toISOString()}] Completed OpenAI API call for article discussion`);let l=c.choices[0].message.content.trim(),u=l.split(/\s+/).length,g=(u/150).toFixed(2);return console.log(`Discussion generated: ${u} words, ~${g} minutes`),u<500&&console.warn(`WARNING: Article discussion may be too short at ${u} words (target: 525-550+ words)`),l}catch(c){throw i.aborted?(console.log("Article discussion generation was cancelled"),new Error("Operation was cancelled")):(console.error(`Error generating article discussion: ${c.message}`),c)}}async function st(e,t,o,n=null){let i=(n||new AbortController).signal,r=e.map(l=>l.title);console.log("Generating conclusion...");let s=De(r,o),c={model:o.model,messages:[{role:"system",content:s}],max_tokens:o.maxTokens,temperature:o.temperature};try{if(i.aborted)throw new Error("Operation was cancelled");console.log(`[${new Date().toISOString()}] Starting OpenAI API call for conclusion`);let l=await ee(async()=>{let g=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(c),signal:i});if(!g.ok){let d=await g.json();throw new Error(`OpenAI API error: ${g.status} - ${JSON.stringify(d)}`)}return await g.json()},o.timeoutSeconds*1e3,i);console.log(`[${new Date().toISOString()}] Completed OpenAI API call for conclusion`);let u=l.choices[0].message.content.trim();return console.log("Conclusion generated"),u}catch(l){throw i.aborted?(console.log("Conclusion generation was cancelled"),new Error("Operation was cancelled")):(console.error(`Error generating conclusion: ${l.message}`),l)}}async function Ne(e,t=()=>{},o=null){let n=o||new AbortController,a=n.signal;try{let{title:i,articleIds:r,script:s,lines:c,settings:l}=e;if(a.aborted)throw new Error("Operation was cancelled");let u=await C("openai_api_key");if(!u)throw new Error("OpenAI API key not found in settings");t({stage:"audio",message:"Generating audio...",progress:65});let g=5,d=60,m=c.length,b=Math.ceil(m/g),h=[];for(let f=0;f<b;f++){if(a.aborted)throw new Error("Operation was cancelled");let y=f*g,U=Math.min(y+g,m)-y,L=65+Math.floor(f/b*30),re=65+Math.floor((f+1)/b*30);t({stage:"audio",message:`Generating audio batch ${f+1}/${b}...`,progress:L,audioProgress:{currentLine:y+1,totalLines:m,progressPercent:Math.floor(y/m*100)}}),console.log("Voice Map Settings:",l.voiceMap);let J=await at(c,y,U,u,d,l.voiceMap,n,P=>{let q=L+Math.floor(P.processed/U*(re-L));t({stage:"audio",message:`Generating audio: ${y+P.processed}/${m}`,progress:q,audioProgress:{currentLine:y+P.processed,totalLines:m,progressPercent:Math.floor((y+P.processed)/m*100)}})});h.push(...J.results)}if(a.aborted)throw new Error("Operation was cancelled");let p=h.filter(f=>f&&f.buffer);if(p.length===0)throw console.error("No valid audio segments were generated"),new Error("Audio generation failed: No valid audio segments were produced");if(console.log(`Sorting ${p.length} audio segments into correct sequence...`),p.sort((f,y)=>f.originalLineIndex!==y.originalLineIndex?f.originalLineIndex-y.originalLineIndex:(f.sequenceIndex||0)-(y.sequenceIndex||0)),console.log("Audio segments in sorted order (first 5):"),p.slice(0,5).forEach((f,y)=>{console.log(`Segment ${y}: Line ${f.originalLineIndex}, ${f.role}, Text: "${f.text.substring(0,30)}..."`)}),a.aborted)throw new Error("Operation was cancelled");let S=p.map(f=>f.buffer),w=p.map(f=>({voice:f.voice,role:f.role,text:f.text}));t({stage:"combining",message:"Combining audio files...",progress:95});let E=lt(S,w),v=new Blob([E],{type:"audio/mp3"});if(a.aborted)throw new Error("Operation was cancelled");t({stage:"saving",message:"Saving podcast...",progress:98});let T={title:i,articleIds:r,script:s,blob:v,type:"podcast",dateCreated:new Date().toISOString(),settings:l},I=await ce(T);if(l.saveSegments&&!a.aborted)for(let f=0;f<p.length&&!a.aborted;f++){let y=p[f],H=new Blob([y.buffer],{type:"audio/mp3"}),U={articleIds:r,podcastId:I,lineIndex:y.originalLineIndex,sequenceIndex:y.sequenceIndex||0,speaker:y.role==="HOST"?l.hostNames.HOST:l.hostNames["CO-HOST"],text:y.text,blob:H,type:"segment",dateCreated:new Date().toISOString()};await ce(U)}if(a.aborted)throw new Error("Operation was cancelled");return t({stage:"complete",message:"Podcast generation complete",progress:100}),{podcastId:I,title:i,duration:dt(v.size),size:v.size}}catch(i){throw a.aborted?(console.log("Podcast audio generation was cancelled"),t({stage:"cancelled",message:"Operation cancelled",progress:0})):(console.error("Error generating podcast audio:",i),t({stage:"error",message:i.message,error:i})),i}}async function at(e,t,o,n,a=60,i={},r=null,s=()=>{}){let l=(r||new AbortController).signal,u=Math.min(t+o,e.length),g=[],d=[],m=0;if(console.log("========================"),console.log("GENERATING AUDIO BATCH:"),console.log(`Lines ${t} to ${u-1}`),console.log("VOICE MAP:",JSON.stringify(i,null,2)),console.log("========================"),!i||!i.HOST||!i["CO-HOST"])throw console.error("INVALID VOICE MAP:",i),new Error("Invalid voice map configuration. Voice map must contain HOST and CO-HOST keys.");if(l.aborted)throw new Error("Operation was cancelled");let b=0,h=0,p=i.HOST,S=i["CO-HOST"];console.log(`HOST VOICE: ${p}`),console.log(`CO-HOST VOICE: ${S}`);let w=["HOST","Host","Hari"],E=["CO-HOST","Co-host","Leela"];console.log("Host identifiers:",w.map(I=>I+":")),console.log("Co-host identifiers:",E.map(I=>I+":"));for(let I=t;I<u;I++){if(l.aborted)throw new Error("Operation was cancelled");let y=e[I].text.trim();if(!y){console.warn(`Empty text for line ${I}, skipping`);continue}let H=/^([^:]+):\s*\1:/;H.test(y)&&(console.log(`FIXING DUPLICATE NAME in line: "${y}"`),y=y.replace(H,"$1:"),console.log(`FIXED to: "${y}"`));let U=ct(y,w.map(L=>L+":"),E.map(L=>L+":"));console.log(`Split line ${I} into ${U.length} speaker turns`);for(let L=0;L<U.length;L++){if(l.aborted)throw new Error("Operation was cancelled");let re=U[L],{speaker:J,text:P}=re;if(!P||P.trim()==="")continue;let q,K;if(J==="HOST")q=p,K="HOST",b++,console.log(`SPEAKER TURN: HOST - "${P.substring(0,30)}..."`);else if(J==="CO-HOST")q=S,K="CO-HOST",h++,console.log(`SPEAKER TURN: CO-HOST - "${P.substring(0,30)}..."`);else{console.error(`Unknown speaker for turn: "${P.substring(0,30)}..."`);continue}console.log(`Voice assigned: ${q} for role: ${K}`),console.log(`Clean text: "${P}"`);let Ye=(async(Ie,se,F,ae,Ae,ve)=>{try{if(l.aborted)throw new Error("Operation was cancelled");console.log(`Generating audio with voice: ${F} for line: "${se.substring(0,30)}..."`);let X=await it(se,F,n,a,l);if(l.aborted)throw new Error("Operation was cancelled");return d.push({buffer:X,voice:F,role:ae,text:se,originalLineIndex:Ae,sequenceIndex:ve}),console.log(`Successfully generated audio for turn with ${ae} voice (${F})`),s({processed:Ie+1}),!0}catch(X){if(l.aborted)throw console.log("Audio generation for line was cancelled"),new Error("Operation was cancelled");return console.error(`Error generating audio: ${X.message}`),d.push({buffer:null,voice:F,role:ae,error:X,originalLineIndex:Ae,sequenceIndex:ve}),s({processed:Ie+1}),!1}})(m++,P,q,K,I,L);g.push(Ye)}}try{await Promise.all(g)}catch(I){if(l.aborted)throw new Error("Operation was cancelled");console.error("Error during batch processing:",I)}if(l.aborted)throw new Error("Operation was cancelled");console.log(`
BATCH RESULTS SUMMARY:`),console.log(`HOST voice (${p}) used: ${b} times`),console.log(`CO-HOST voice (${S}) used: ${h} times`),console.log(`Total speaker turns processed: ${b+h}`);let v=0,T=0;for(let I of d)I&&I.buffer?v++:I&&I.error&&T++;return console.log(`Success: ${v}, Errors: ${T}`),console.log(`========================
`),{results:d,startIndex:t,endIndex:u-1}}async function it(e,t,o,n=60,a=null){if(!e||e.trim()==="")throw new Error("Cannot generate audio for empty text");if(!t)throw new Error("Voice ID is required for audio generation");console.log(`Generating audio with voice=${t} for text: "${e.substring(0,30)}..."`);let i=a?null:new AbortController,r=a||(i==null?void 0:i.signal),s=setTimeout(()=>{i&&i.abort()},n*1e3);try{let c=await fetch("https://api.openai.com/v1/audio/speech",{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({model:"tts-1",voice:t,input:e}),signal:r});if(!c.ok){let g=`API error: ${c.status}`;try{let d=await c.text();g+=` - ${d}`}catch(d){}throw new Error(g)}let l=await c.arrayBuffer();return console.log(`Successfully received ${l.byteLength} bytes of audio data`),new Uint8Array(l)}catch(c){throw c.name==="AbortError"?a&&a.aborted?new Error("Operation was cancelled"):new Error(`Request timed out after ${n} seconds`):new Error(`Audio generation failed: ${c.message}`)}finally{clearTimeout(s)}}function ct(e,t,o){if(!e||e.trim()==="")return[];console.log("Processing text for speaker turns:"),console.log("Host identifiers:",t),console.log("Co-host identifiers:",o);let n=[...t,...o].map(s=>s.replace(/:/g,"")),a=new RegExp(`(${n.join("|")})\\s*:\\s+`,"g");console.log(`Using speaker pattern: ${a}`);let i=e.split(/\n+|---+|\r\n/),r=[];for(let s of i){if(!s.trim())continue;let c=Array.from(s.matchAll(a));if(c.length===0){let l=null,u=s.trim(),g=u.match(/^([^:]+):\s*/);if(g){let d=g[1].trim();for(let m of t){let b=m.replace(/:/g,"").trim();if(d.toLowerCase()===b.toLowerCase()){l="HOST",u=u.substring(g[0].length).trim(),console.log(`Found host prefix in segment: ${d}`);break}}if(!l)for(let m of o){let b=m.replace(/:/g,"").trim();if(d.toLowerCase()===b.toLowerCase()||d.toLowerCase().includes("leela")){l="CO-HOST",u=u.substring(g[0].length).trim(),console.log(`Found co-host prefix in segment: ${d}`);break}}}if(!l){for(let d of t)if(s.includes(d)){l="HOST";break}}if(!l){for(let d of o)if(s.includes(d)){l="CO-HOST";break}}r.push({speaker:l||"HOST",text:u}),console.log(`Processed segment without clear markers: Speaker=${l||"HOST"}, Text="${u.substring(0,30)}..."`);continue}for(let l=0;l<c.length;l++){let u=c[l],g=u[1].trim(),d="HOST";if(g.toLowerCase().includes("leela"))d="CO-HOST",console.log(`Detected Leela as speaker: ${g}`);else for(let w of o){let E=w.replace(/:/g,"").trim();if(g.toLowerCase()===E.toLowerCase()){d="CO-HOST",console.log(`Matched co-host identifier: ${E}`);break}}let m=u.index,b=c[l+1],h=b?b.index:s.length,p=s.substring(m,h).trim(),S=p.replace(/^[^:]+:\s*/,"").trim();S&&(r.push({speaker:d,text:S}),console.log(`Identified turn: Speaker=${d}, Text="${S.substring(0,30)}..."`),console.log(`Removed prefix from: "${p.substring(0,Math.min(40,p.length))}..."`))}}if(r.length===0&&e.trim()!==""){let s=e.trim(),c=s.match(/^([^:]+):\s*/),l=s;c&&(l=s.substring(c[0].length).trim(),console.log(`Removed prefix in fallback: "${c[0]}"`)),r.push({speaker:"HOST",text:l}),console.log(`No clear turns found, defaulting to HOST with text: "${l.substring(0,30)}..."`)}return console.log(`Split into ${r.length} turns`),r}function lt(e,t){if(console.log("Combining audio buffers..."),!e||e.length===0)return console.warn("No audio buffers to combine, returning empty buffer"),new Uint8Array(0);let o=e.reduce((r,s)=>r+s.length,0);console.log(`Total audio size: ${N(o)} (${o} bytes)`),console.log(`Total number of segments: ${e.length}`),G("Before Buffer Allocation"),console.log(`Allocating buffer of ${N(o)}`);let n=new Uint8Array(o);G("After Buffer Allocation");let a=0,i=0;for(let r=0;r<e.length;r++){let s=e[r];if(n.set(s,a),a+=s.length,i+=s.length,t&&t[r]?(console.log(`Added segment ${r+1}: Speaker="${t[r].role}", Voice=${t[r].voice}, Length: ${s.length} bytes`),(r<5||r>=e.length-5)&&console.log(`Segment ${r+1} text: "${t[r].text.substring(0,50)}..."`)):console.log(`Added segment ${r+1}, Length: ${s.length} bytes`),(r+1)%10===0||r===e.length-1){let c=Math.round((r+1)/e.length*100);console.log(`Combined ${r+1}/${e.length} segments (${c}%)`),console.log(`Current offset: ${a} bytes (${N(a)})`),G(`After Combining ${r+1} Audio Segments`)}}return console.log(`Combined buffer size verification: ${n.length} bytes (expected ${o} bytes)`),console.log(`Segments total size: ${i} bytes (${N(i)})`),G("After Combining All Buffers"),n}function dt(e){return Math.round(e/(16*1024))}async function Me(e,t={},o=()=>{}){let n=new AbortController,a=n.signal,i=()=>{console.log("Podcast generation has been cancelled by user"),n.abort(),o({stage:"cancelled",message:"Podcast generation cancelled",progress:0})};try{let r=await He(e,t,o,n);return r.cancelGeneration=i,Ne(r,o,n).then(s=>{a.aborted||o({stage:"complete",message:"Podcast generation complete",progress:100,audioData:s})}).catch(s=>{a.aborted||o({stage:"error",message:`Error generating podcast audio: ${s.message}`,error:s})}),Q(V({},r),{audioGenerationInProgress:!0,cancelGeneration:i})}catch(r){throw a.aborted?(console.log("Podcast generation was cancelled"),o({stage:"cancelled",message:"Operation cancelled",progress:0})):(console.error("Error in podcast generation:",r),o({stage:"error",message:r.message,error:r})),r}}var k=[],O=[],x=new Set,$=1,pe=12,fe=null,ut=null,_=[],D=new Set,Y=new Set;document.addEventListener("DOMContentLoaded",gt);function gt(){mt().then(()=>{M(k),Lt(),je(),pt(),we("articles")})}async function pt(){let e=document.getElementById("hostVoiceSelect"),t=document.getElementById("cohostVoiceSelect"),o=await C("host_voice");o&&(e.value=o);let n=await C("cohost_voice");n&&(t.value=n)}async function mt(){try{k=await Te(),k.sort((t,o)=>new Date(o.dateAdded)-new Date(t.dateAdded)),O=[...k],M(O),x.clear(),j(),await C("openai_api_key")||B("OpenAI API key not set. Please go to settings and add your API key to generate podcasts.","warning")}catch(e){console.error("Error loading articles:",e),B(`Error loading articles: ${e.message}`,"error")}}function Se(e,t){if(!e&&!t){O=[...k],$=1,M(O);return}e||(e=new Date(0)),t||(t=new Date),t=new Date(t),t.setHours(23,59,59,999),O=k.filter(n=>{let a=new Date(n.dateAdded);return a>=e&&a<=t}),$=1,M(O);let o=O.length;B(`Showing ${o} article${o!==1?"s":""} in the selected date range`,"info")}function ht(){let e=document.getElementById("startDateFilter"),t=document.getElementById("endDateFilter"),o=e.value?new Date(e.value):null,n=t.value?new Date(t.value):null;Se(o,n)}function ft(){let e=document.getElementById("startDateFilter"),t=document.getElementById("endDateFilter");e.value="",t.value="",Se(null,null)}function ne(e){let t=new Date,o;switch(e){case"today":o=new Date(t),o.setHours(0,0,0,0);break;case"week":o=new Date(t),o.setDate(t.getDate()-7);break;case"month":o=new Date(t),o.setMonth(t.getMonth()-1);break;case"year":o=new Date(t),o.setFullYear(t.getFullYear()-1);break;default:o=null;break}let n=document.getElementById("startDateFilter"),a=document.getElementById("endDateFilter");o?n.value=o.toISOString().split("T")[0]:n.value="",a.value=t.toISOString().split("T")[0],Se(o,t)}function M(e){let t=document.getElementById("articles-container");if(t.innerHTML="",e.length===0){t.innerHTML='<div class="no-articles">No articles found. Save some articles first!</div>';return}let o=Math.ceil(e.length/pe);$>o&&($=1);let n=($-1)*pe,a=Math.min(n+pe,e.length);e.slice(n,a).forEach(r=>{let s=yt(r);if(t.appendChild(s),Y.has(r.id)){let c=s.querySelector(".card-full-content"),l=s.querySelector(".toggle-icon"),u=s.querySelector(".toggle-text");c.style.display="block",l.textContent="\u25B2",u.textContent="Hide Full Article"}}),wt(o)}function yt(e){let t=document.createElement("div");t.className="article-card",t.dataset.id=e.id;let n=new Date(e.dateAdded).toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"}),a=e.summary||e.content.slice(0,150)+"...",i=e.content.split(/\s+/).length,r=Math.ceil(i/200);t.innerHTML=`
    <div class="card-header">
      <label class="checkbox-container">
        <input type="checkbox" class="article-checkbox" data-id="${e.id}" ${x.has(e.id)?"checked":""}>
        <span class="checkmark"></span>
      </label>
      <h3 class="card-title">${e.title||"Untitled Article"}</h3>
    </div>
    <div class="card-body">
      <div class="card-content">
        <p class="card-summary">${a}</p>
        <div class="card-full-content" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
          <div class="article-stats" style="margin-bottom: 10px; font-size: 12px; color: var(--text-light);">
            <span>${i.toLocaleString()} words</span> \u2022 
            <span>~${r} min read</span>
          </div>
          <div class="full-text" style="max-height: 300px; overflow-y: auto;">${e.content}</div>
        </div>
      </div>
      <button class="toggle-content-btn" aria-label="Toggle full content">
        <span class="toggle-icon">\u25BC</span>
        <span class="toggle-text">Show Full Article</span>
      </button>
    </div>
    <div class="card-footer">
      <div class="meta-info">
        <div>${n}</div>
        <div>${e.url?new URL(e.url).hostname:"No URL"}</div>
      </div>
      <div class="card-actions">
        <button class="view-btn" title="View Article" data-id="${e.id}">\u{1F441}\uFE0F</button>
        <button class="delete-btn" title="Delete Article" data-id="${e.id}">\u{1F5D1}\uFE0F</button>
      </div>
    </div>
  `,t.querySelector(".article-checkbox").addEventListener("change",b=>{Ue(e.id,b.target.checked)}),t.querySelector(".view-btn").addEventListener("click",()=>{e.url?window.open(e.url,"_blank"):B("No URL available for this article","warning")}),t.querySelector(".delete-btn").addEventListener("click",()=>{confirm(`Are you sure you want to delete "${e.title||"this article"}"?`)&&St(e.id)});let u=t.querySelector(".toggle-content-btn"),g=t.querySelector(".card-full-content"),d=t.querySelector(".toggle-icon"),m=t.querySelector(".toggle-text");return u.addEventListener("click",()=>{let b=g.style.display!=="none",h=e.id;b?(g.style.display="none",d.textContent="\u25BC",m.textContent="Show Full Article",Y.delete(h)):(g.style.display="block",d.textContent="\u25B2",m.textContent="Hide Full Article",Y.add(h))}),t}function wt(e){let t=document.getElementById("pagination");if(t.innerHTML="",e<=1){t.style.display="none";return}t.style.display="flex";let o=document.createElement("button");o.innerHTML="&laquo;",o.disabled=$===1,o.addEventListener("click",()=>{$>1&&($--,M(O))}),t.appendChild(o);let n=5,a=Math.max(1,$-Math.floor(n/2)),i=Math.min(e,a+n-1);for(let s=a;s<=i;s++){let c=document.createElement("button");c.textContent=s,c.className=s===$?"active":"",c.addEventListener("click",()=>{$=s,M(O)}),t.appendChild(c)}let r=document.createElement("button");r.innerHTML="&raquo;",r.disabled=$===e,r.addEventListener("click",()=>{$<e&&($++,M(O))}),t.appendChild(r)}function Ue(e,t){t?x.add(e):x.delete(e),j()}function bt(e){let t=e.target.checked;document.querySelectorAll(".article-checkbox").forEach(o=>{o.checked=t,Ue(parseInt(o.dataset.id),t)}),j()}function j(){let e=document.getElementById("generatePodcastBtn"),t=document.getElementById("exportSelectedBtn"),o=document.getElementById("deleteSelectedBtn"),n=x.size>0;e.disabled=!n,t.disabled=!n,o.disabled=!n}function me(e){!e||e.trim()===""?O=[...k]:(e=e.toLowerCase().trim(),O=k.filter(t=>{let o=(t.title||"").toLowerCase(),n=(t.content||"").toLowerCase(),a=(t.summary||"").toLowerCase();return o.includes(e)||n.includes(e)||a.includes(e)})),$=1,M(O)}async function St(e){try{await ie(e),k=k.filter(t=>t.id!==e),O=O.filter(t=>t.id!==e),x.delete(e),M(O),j(),B("Article deleted successfully","success")}catch(t){console.error("Error deleting article:",t),B(`Error deleting article: ${t.message}`,"error")}}async function Ve(){if(x.size===0)return;let e=x.size===1?"Are you sure you want to delete the selected article?":`Are you sure you want to delete ${x.size} selected articles?`;if(confirm(e))try{let t=Array.from(x).map(o=>ie(o));await Promise.all(t),k=k.filter(o=>!x.has(o.id)),O=O.filter(o=>!x.has(o.id)),x.clear(),M(O),j(),B("Selected articles deleted successfully","success")}catch(t){console.error("Error deleting articles:",t),B(`Error deleting articles: ${t.message}`,"error")}}async function Et(){if(x.size!==0)try{let e=await Promise.all(Array.from(x).map(r=>Z(r))),t=[];for(let r of e){let s=await $e(r.id);t.push(...s)}let o={articles:e,audio:t,exportDate:new Date().toISOString(),version:"1.0"},n=new Blob([JSON.stringify(o,null,2)],{type:"application/json"}),a=URL.createObjectURL(n),i=document.createElement("a");i.href=a,i.download=`article-export-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(a),B(`${e.length} articles exported successfully`,"success")}catch(e){console.error("Error exporting articles:",e),B(`Error exporting articles: ${e.message}`,"error")}}function ye(){let e=document.getElementById("hostVoiceSelect").value,t=document.getElementById("cohostVoiceSelect").value,o=document.getElementById("startGenerateBtn");o.disabled=!e||!t||e===t,e&&t&&e===t&&B("Please select different voices for host and co-host","warning")}async function It(){if(console.log("openGeneratePodcastModal called, selectedArticles size:",x.size),x.size===0){console.log("No articles selected, returning...");return}let e=document.getElementById("generatePodcastModal"),t=document.getElementById("podcastTitle");if(!e||!t){console.error("Modal or title input not found!");return}console.log("Setting up the modal..."),document.getElementById("progressContainer").style.display="none",document.getElementById("generatedPodcast").style.display="none",document.getElementById("startGenerateBtn").style.display="block",document.getElementById("downloadPodcastBtn").style.display="none";let o=new Date,n=o.getDate(),a=o.toLocaleString("en-US",{month:"short"}),i=o.getFullYear();t.value=`${n} ${a}, ${i}`;try{let r=await C("host_voice");r&&(document.getElementById("hostVoiceSelect").value=r);let s=await C("cohost_voice");s&&(document.getElementById("cohostVoiceSelect").value=s)}catch(r){console.error("Error loading voice settings:",r)}ye(),console.log("Displaying the modal..."),e.style.display="flex"}function Re(){let e=document.getElementById("generatePodcastModal");e.style.display="none"}async function At(){if(x.size===0)return;let e=Array.from(x),t=document.getElementById("podcastTitle").value,o=document.getElementById("hostVoiceSelect").value,n=document.getElementById("cohostVoiceSelect").value,a=document.getElementById("includeIntro").checked,i=document.getElementById("includeConclusion").checked;try{await le("host_voice",o),await le("cohost_voice",n)}catch(l){console.error("Error saving voice settings:",l)}let r={alloy:"Esha",echo:"Hari",fable:"Mira",onyx:"Tej",nova:"Leela",shimmer:"Veena"},s=r[o],c=r[n];document.getElementById("progressContainer").style.display="block",document.getElementById("startGenerateBtn").disabled=!0,document.getElementById("progressText").textContent=`Starting podcast generation with ${s} and ${c}...`,document.getElementById("progressFill").style.width="5%";try{if(!await C("openai_api_key"))throw new Error("OpenAI API key not set. Please go to settings and add your API key.");let g=await Me(e,{title:t,voiceMap:{HOST:o,"CO-HOST":n},hostNames:{HOST:s,"CO-HOST":c},includeIntroduction:a,includeConclusion:i,nameReplacements:{Alice:s,Bob:c}},vt);document.getElementById("generatedPodcast").style.display="block",document.getElementById("startGenerateBtn").style.display="none";let d=document.getElementById("podcastScript")||document.createElement("div");document.getElementById("podcastScript")||(d.id="podcastScript",d.style.display="none",d.style.maxHeight="300px",d.style.overflowY="auto",d.style.border="1px solid var(--border-color)",d.style.borderRadius="6px",d.style.padding="15px",d.style.background="#f8f9fa",d.style.whiteSpace="pre-wrap",d.style.lineHeight="1.5",document.querySelector(".script-container").appendChild(d));let m=g.script.split(`
`).map(w=>{let E=w.split(":")[0],v=w;return w.startsWith("HOST:")?v=w.replace("HOST:",`${s}:`):w.startsWith("CO-HOST:")&&(v=w.replace("CO-HOST:",`${c}:`)),E===s||E==="HOST"?`<span style="color: #2563eb;">${v}</span>`:E===c||E==="CO-HOST"?`<span style="color: #dc2626;">${v}</span>`:v}).join(`
`);d.innerHTML=m;let b=document.getElementById("scriptToggle");if(b){let w=b.cloneNode(!0);b.parentNode.replaceChild(w,b),w.addEventListener("click",function(){let E=document.getElementById("podcastScript");E.style.display==="none"?(E.style.display="block",w.textContent="Hide Script"):(E.style.display="none",w.textContent="Show Script")})}let h=document.getElementById("audioStatus")||document.createElement("div");document.getElementById("audioStatus")||(h.id="audioStatus",h.className="audio-status",document.getElementById("generatedPodcast").appendChild(h)),h.innerHTML="<p>Audio is being generated in the background. The player will appear when ready.</p>",document.getElementById("downloadPodcastBtn").style.display="none",ut=g,fe=g.podcastId,document.getElementById("generatedPodcast").style.display="block",document.getElementById("startGenerateBtn").style.display="none",document.getElementById("downloadPodcastBtn").style.display="block";let p=document.getElementById("audioPlayer"),S=await W(g.podcastId);if(S&&S.blob){let w=URL.createObjectURL(S.blob);p.src=w;let E=Ge(kt(g.duration)),v=(g.size/(1024*1024)).toFixed(2);if(document.getElementById("podcastInfo").textContent=`Duration: ${E} | Size: ${v} MB | Articles: ${e.length}`,S.script){let T=document.getElementById("podcastScript");T.textContent=S.script;let I=document.getElementById("scriptToggle");I.addEventListener("click",function(){let f=document.getElementById("podcastScript");f.style.display==="none"?(f.style.display="block",I.textContent="Hide Script"):(f.style.display="none",I.textContent="Show Script")})}}}catch(l){console.error("Error generating podcast:",l),document.getElementById("progressText").textContent=`Error: ${l.message}`,document.getElementById("progressFill").style.backgroundColor="var(--error-color)"}finally{document.getElementById("startGenerateBtn").disabled=!1}}async function qe(){if(fe)try{let e=await W(fe);if(!e||!e.blob)throw new Error("Podcast audio not found");let t=URL.createObjectURL(e.blob),o=document.createElement("a");o.href=t,o.download=`${e.title||"podcast"}.mp3`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(t)}catch(e){console.error("Error downloading podcast:",e),B(`Error downloading podcast: ${e.message}`,"error")}}async function W(e){return new Promise((t,o)=>{let n=indexedDB.open(z,2);n.onerror=a=>{o(new Error("Failed to open database."))},n.onsuccess=a=>{let c=a.target.result.transaction(["audio"],"readonly").objectStore("audio").get(e);c.onsuccess=l=>{t(l.target.result)},c.onerror=l=>{o(new Error("Failed to retrieve audio file."))}}})}async function vt(e){let t=document.getElementById("progressText"),o=document.getElementById("progressFill");if(e.error){t.textContent=`Error: ${e.message}`,o.style.backgroundColor="var(--error-color)";return}if(t.textContent=e.message||"Processing...",o.style.width=`${e.progress||0}%`,e.stage==="complete"){document.getElementById("progressText").textContent="Podcast generation complete",document.getElementById("progressFill").style.width="100%";let n=document.getElementById("downloadPodcastBtn");n.style.display="block";let a=n.cloneNode(!0);n.parentNode.replaceChild(a,n),a.addEventListener("click",qe);let i=document.getElementById("audioStatus");i&&(i.innerHTML="<p>Audio generation complete!</p>"),document.getElementById("downloadPodcastBtn").style.display="block";let r=document.getElementById("audioPlayer");W(e.audioData.podcastId).then(s=>{var c,l;if(s&&s.blob){let u=URL.createObjectURL(s.blob);r.src=u,r.style.display="block";let g=Ge(e.audioData.duration),d=(e.audioData.size/(1024*1024)).toFixed(2);document.getElementById("podcastInfo").textContent=`Duration: ${g} | Size: ${d} MB | Articles: ${((l=(c=e.audioData)==null?void 0:c.articleIds)==null?void 0:l.length)||"Unknown"}`}}).catch(s=>{console.error("Error loading audio:",s),B(`Error loading audio: ${s.message}`,"error")})}}function B(e,t){let o=document.getElementById("statusMessage");o.textContent=e,o.className=`status-message ${t}`,o.style.display="block",setTimeout(()=>{o.style.display="none"},5e3)}function we(e){if(e!=="articles"&&e!=="podcasts"){console.warn(`Invalid view: ${e}. Only 'articles' and 'podcasts' are supported.`);return}let t=document.getElementById("articlesView"),o=document.getElementById("podcastsView"),n=document.getElementById("viewArticlesBtn"),a=document.getElementById("viewPodcastsBtn"),i=document.getElementById("deleteSelectedBtn");if(!t||!o){console.error("Required view elements are missing.");return}if(i){let r=i.cloneNode(!0);i.parentNode.replaceChild(r,i)}if(e==="articles"){t.style.display="block",o.style.display="none",n&&a&&(n.classList.add("active"),a.classList.remove("active")),D.clear();let r=document.getElementById("deleteSelectedBtn");r&&(r.addEventListener("click",Ve),j())}else if(e==="podcasts"){t.style.display="none",o.style.display="block",n&&a&&(n.classList.remove("active"),a.classList.add("active")),x.clear();let r=document.getElementById("deleteSelectedBtn");r&&(r.addEventListener("click",Tt),Ee()),je()}}async function je(){try{_=await xt(),Fe(_)}catch(e){console.error("Error loading podcasts:",e),B("Error loading podcasts: "+e.message,"error")}}async function xt(){return new Promise((e,t)=>{let o=indexedDB.open(z,2);o.onerror=()=>{t(new Error("Failed to open database."))},o.onsuccess=n=>{let i=n.target.result.transaction(["audio"],"readonly"),s=i.objectStore("audio").index("type"),c=IDBKeyRange.only("podcast"),l=[];s.openCursor(c).onsuccess=u=>{let g=u.target.result;if(g){let d=V({},g.value);delete d.blob,l.push(d),g.continue()}else l.sort((d,m)=>new Date(m.dateCreated)-new Date(d.dateCreated)),e(l)},i.onerror=()=>{t(new Error("Failed to retrieve podcasts."))}}})}function Fe(e){let t=document.getElementById("podcasts-container");t.innerHTML="";let o=document.createElement("div");if(o.className="select-all-container",o.style.cssText="padding: 15px 0; margin-bottom: 20px; border-bottom: 1px solid var(--border-color);",o.innerHTML=`
    <label class="checkbox-container" style="display: inline-flex; align-items: center; font-size: 15px; color: var(--text-color); font-weight: 500;">
      <input type="checkbox" id="selectAllPodcastsCheckbox">
      <span class="checkmark"></span>
      <span class="checkbox-label" style="margin-left: 24px; white-space: nowrap;">Select All Podcasts</span>
    </label>
  `,t.appendChild(o),!e||e.length===0){t.innerHTML+=`<div class="no-podcasts" style="grid-column: 1 / -1; text-align: center; padding: 30px;">
      <p>No podcasts found. Generate a podcast from articles to see them here.</p>
    </div>`;return}document.getElementById("selectAllPodcastsCheckbox").addEventListener("change",Ot),e.forEach(a=>{let i=Bt(a);t.appendChild(i)})}function Bt(e){var d,m,b,h;let t=document.createElement("div");t.className="podcast-card";let o=new Date(e.dateCreated),n=o.toLocaleDateString()+" "+o.toLocaleTimeString(),a="";if(e.articleIds&&e.articleIds.length>0){let p=[];for(let S of e.articleIds){let w=k.find(E=>E.id===S);w&&p.push(w.title||"Untitled Article")}p.length>0&&(a=`
        <div class="podcast-articles">
          <h4>Articles</h4>
          ${p.map(S=>`<div class="article-title">${S}</div>`).join("")}
        </div>
      `)}let i=((m=(d=e.settings)==null?void 0:d.hostNames)==null?void 0:m.HOST)||"Host",r=((h=(b=e.settings)==null?void 0:b.hostNames)==null?void 0:h["CO-HOST"])||"Co-Host",s=`
    <div class="speaker-info">
      Host: ${i} | Co-Host: ${r}
    </div>
  `;t.innerHTML=`
    <div class="podcast-header">
      <div style="display: flex; align-items: center;">
        <label class="checkbox-container" style="margin-right: 12px;">
          <input type="checkbox" class="podcast-checkbox" data-id="${e.id}" ${D.has(e.id)?"checked":""}>
          <span class="checkmark"></span>
        </label>
        <h3 class="podcast-title">${e.title||"Untitled Podcast"}</h3>
      </div>
    </div>
    <div class="podcast-body">
      <div class="podcast-info">
        Created: ${n}
      </div>
      <audio class="audio-player" controls></audio>
      ${s}
      ${a}
      <div class="podcast-actions" style="margin-top: 15px;">
        <button class="btn btn-secondary view-script-btn">View Script</button>
        <button class="btn btn-primary download-btn">Download</button>
      </div>
    </div>
  `;let c=t.querySelector(".audio-player");return W(e.id).then(p=>{if(p&&p.blob){let S=URL.createObjectURL(p.blob);c.src=S}}),t.querySelector(".podcast-checkbox").addEventListener("change",p=>{ze(e.id,p.target.checked)}),t.querySelector(".view-script-btn").addEventListener("click",()=>{let p=document.createElement("div");p.className="modal",p.style.display="flex";let S=(e.script||"No script available").split(`
`).map(E=>{let v=E.split(":")[0],T=E;return E.startsWith("HOST:")?T=E.replace("HOST:",`${i}:`):E.startsWith("CO-HOST:")&&(T=E.replace("CO-HOST:",`${r}:`)),v===i||v==="HOST"?`<span style="color: #2563eb;">${T}</span>`:v===r||v==="CO-HOST"?`<span style="color: #dc2626;">${T}</span>`:T}).join(`
`);p.innerHTML=`
      <div class="modal-content" style="width: 80%; max-width: 800px;">
        <div class="modal-header">
          <h2>Podcast Script</h2>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
          <pre style="white-space: pre-wrap; padding: 10px; background: #f8f9fa; border-radius: 6px; line-height: 1.6;">${S}</pre>
        </div>
      </div>
    `,document.body.appendChild(p),p.querySelector(".modal-close").addEventListener("click",()=>{document.body.removeChild(p)}),p.addEventListener("click",E=>{E.target===p&&document.body.removeChild(p)})}),t.querySelector(".download-btn").addEventListener("click",()=>{W(e.id).then(p=>{if(p&&p.blob){let S=URL.createObjectURL(p.blob),w=document.createElement("a");w.href=S,w.download=`${e.title||"podcast"}.mp3`,document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(S)}}).catch(p=>{console.error("Error downloading podcast:",p),B(`Error downloading podcast: ${p.message}`,"error")})}),t}function ze(e,t){t?D.add(e):D.delete(e),Ee()}function Ot(e){let t=e.target.checked;document.querySelectorAll(".podcast-checkbox").forEach(o=>{o.checked=t,ze(parseInt(o.dataset.id),t)}),Ee()}function Ee(){let e=D.size>0,t=document.getElementById("deleteSelectedBtn");t&&(t.disabled=!e)}async function Tt(){if(D.size===0)return;let e=D.size===1?"Are you sure you want to delete the selected podcast?":`Are you sure you want to delete ${D.size} selected podcasts?`;if(confirm(e))try{let t=Array.from(D).map(o=>$t(o));await Promise.all(t),_=_.filter(o=>!D.has(o.id)),D.clear(),Fe(_),B("Selected podcasts deleted successfully","success")}catch(t){console.error("Error deleting podcasts:",t),B(`Error deleting podcasts: ${t.message}`,"error")}}async function $t(e){return new Promise((t,o)=>{let n=indexedDB.open(z,2);n.onerror=()=>{o(new Error("Failed to open database."))},n.onsuccess=a=>{let c=a.target.result.transaction(["audio"],"readwrite").objectStore("audio").delete(e);c.onsuccess=()=>{t()},c.onerror=()=>{o(new Error("Failed to delete podcast."))}}})}function Ct(){let e=document.getElementById("toggleAllBtn"),t=document.getElementById("toggleAllIcon"),o=document.getElementById("toggleAllText"),n=document.querySelectorAll(".article-card"),a=o.textContent.includes("Expand");n.forEach(i=>{let r=parseInt(i.dataset.id),s=i.querySelector(".card-full-content"),c=i.querySelector(".toggle-icon"),l=i.querySelector(".toggle-text");a?(s.style.display="block",c.textContent="\u25B2",l.textContent="Hide Full Article",Y.add(r)):(s.style.display="none",c.textContent="\u25BC",l.textContent="Show Full Article",Y.delete(r))}),a?(t.textContent="\u25B2",o.textContent="Collapse All"):(t.textContent="\u25BC",o.textContent="Expand All")}function kt(e){return typeof te=="function"?te(e):Math.round(e/(16*1024))}function Ge(e){if(typeof oe=="function")return oe(e);let t=Math.floor(e/60),o=Math.floor(e%60);return`${t}:${o.toString().padStart(2,"0")}`}function Lt(){let e=document.getElementById("viewArticlesBtn");e&&e.addEventListener("click",()=>we("articles"));let t=document.getElementById("viewPodcastsBtn");t&&t.addEventListener("click",()=>we("podcasts"));let o=document.getElementById("searchInput");o&&(o.addEventListener("input",y=>me(y.target.value)),o.addEventListener("keypress",y=>{if(y.key==="Enter"){let H=o.value.trim();me(H)}}));let n=document.getElementById("searchBtn");n&&n.addEventListener("click",()=>{var H;let y=((H=document.getElementById("searchInput"))==null?void 0:H.value.trim())||"";me(y)});let a=document.getElementById("deleteSelectedBtn");a&&a.addEventListener("click",Ve);let i=document.getElementById("exportSelectedBtn");i&&i.addEventListener("click",Et);let r=document.getElementById("generatePodcastBtn");r&&r.addEventListener("click",It);let s=document.querySelector("#generatePodcastModal .modal-close");s&&s.addEventListener("click",Re);let c=document.getElementById("cancelGenerateBtn");c&&c.addEventListener("click",Re);let l=document.getElementById("startGenerateBtn");l&&l.addEventListener("click",At);let u=document.getElementById("downloadPodcastBtn");u&&u.addEventListener("click",qe);let g=document.getElementById("scriptToggle");g&&g.addEventListener("click",Ht);let d=document.getElementById("previewHostVoice");d&&d.addEventListener("click",Pt);let m=document.getElementById("previewCohostVoice");m&&m.addEventListener("click",Dt);let b=document.getElementById("selectAllCheckbox");b&&b.addEventListener("change",bt);let h=document.getElementById("toggleAllBtn");h&&h.addEventListener("click",Ct);let p=document.getElementById("applyDateFilterBtn");p&&p.addEventListener("click",ht);let S=document.getElementById("resetDateFilterBtn");S&&S.addEventListener("click",ft);let w=document.getElementById("todayFilterBtn");w&&w.addEventListener("click",()=>ne("today"));let E=document.getElementById("weekFilterBtn");E&&E.addEventListener("click",()=>ne("week"));let v=document.getElementById("monthFilterBtn");v&&v.addEventListener("click",()=>ne("month"));let T=document.getElementById("yearFilterBtn");T&&T.addEventListener("click",()=>ne("year"));let I=document.getElementById("hostVoiceSelect"),f=document.getElementById("cohostVoiceSelect");I&&I.addEventListener("change",()=>{he(),ye()}),f&&f.addEventListener("change",()=>{he(),ye()}),he()}async function Pt(){let e=document.getElementById("hostVoiceSelect").value;await _e(e)}async function Dt(){let e=document.getElementById("cohostVoiceSelect").value;await _e(e)}async function _e(e){try{let t={alloy:"Esha",echo:"Hari",fable:"Mira",onyx:"Tej",nova:"Leela",shimmer:"Veena"};B(`Loading ${t[e]} voice sample...`,"info");let o=await C("openai_api_key");if(!o)throw new Error("OpenAI API key not set. Please go to settings and add your API key.");let a={alloy:"Hi, I'm Esha. I am a versatile voice that can adapt to various content styles.",echo:"Hi, I'm Hari. I have a soft-spoken and articulate voice, ideal for educational content.",fable:"Hi, I'm Mira. I have a narration style that's great for storytelling and creative content.",onyx:"Hi, I'm Tej. I have a deep, authoritative voice suited for professional presentations.",nova:"Hi, I'm Leela. My voice is clear and energetic, good for delivering news or explanations.",shimmer:"Hi, I'm Veena. I have a warm, welcoming voice perfect for friendly conversations."}[e]||`This is a sample of the ${e} voice.`,i=document.querySelectorAll("#previewHostVoice, #previewCohostVoice");i.forEach(u=>{u.disabled=!0,u.textContent="Loading..."});let r=await fetch("https://api.openai.com/v1/audio/speech",{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({model:"tts-1",voice:e,input:a})});if(!r.ok){let u=await r.json();throw new Error(`OpenAI API error: ${r.status} - ${JSON.stringify(u)}`)}let s=await r.blob(),c=URL.createObjectURL(s),l=new Audio(c);l.onended=()=>{URL.revokeObjectURL(c),i.forEach(u=>{u.disabled=!1,u.textContent="Preview Voice"})},l.play(),B(`Playing ${t[e]} voice sample`,"success")}catch(t){console.error("Error playing voice sample:",t),B(`Error playing voice sample: ${t.message}`,"error"),document.querySelectorAll("#previewHostVoice, #previewCohostVoice").forEach(n=>{n.disabled=!1,n.textContent="Preview Voice"})}}function Ht(){let e=document.getElementById("podcastScript"),t=document.getElementById("scriptToggle");e.style.display==="none"?(e.style.display="block",t.textContent="Hide Script"):(e.style.display="none",t.textContent="Show Script")}function he(){let e={alloy:"Esha",echo:"Hari",fable:"Mira",onyx:"Tej",nova:"Leela",shimmer:"Veena"},t=document.getElementById("hostVoiceSelect"),o=document.getElementById("cohostVoiceSelect"),n=document.querySelector('label[for="hostVoiceSelect"]'),a=document.querySelector('label[for="cohostVoiceSelect"]');if(t){let i=t.value;t.innerHTML=Object.entries(e).map(([r,s])=>`<option value="${r}">${s}</option>`).join(""),t.value=i}if(o){let i=o.value;o.innerHTML=Object.entries(e).map(([r,s])=>`<option value="${r}">${s}</option>`).join(""),o.value=i}n&&(n.textContent="Host Voice"),a&&(a.textContent="Co-Host Voice")}})();
