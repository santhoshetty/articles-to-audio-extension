(()=>{var m="ArticleToAudioDB";var l={ARTICLES:"articles",AUDIO:"audio",SETTINGS:"settings"};function p(){return new Promise((n,s)=>{let o=indexedDB.open(m,2);o.onerror=r=>{console.error("Database error:",r.target.error),s(r.target.error)},o.onsuccess=r=>{let e=r.target.result;console.log("Database opened successfully"),n(e)},o.onupgradeneeded=r=>{let e=r.target.result,u=r.oldVersion;if(console.log(`Database upgrade needed from version ${u} to 2`),u<1){if(!e.objectStoreNames.contains(l.ARTICLES)){let t=e.createObjectStore(l.ARTICLES,{keyPath:"id",autoIncrement:!0});t.createIndex("url","url",{unique:!0}),t.createIndex("title","title",{unique:!1}),t.createIndex("dateAdded","dateAdded",{unique:!1}),console.log("Articles store created")}if(!e.objectStoreNames.contains(l.AUDIO)){let t=e.createObjectStore(l.AUDIO,{keyPath:"id",autoIncrement:!0});t.createIndex("articleId","articleId",{unique:!1}),t.createIndex("type","type",{unique:!1}),t.createIndex("dateCreated","dateCreated",{unique:!1}),console.log("Audio store created")}if(!e.objectStoreNames.contains(l.SETTINGS)){let t=e.createObjectStore(l.SETTINGS,{keyPath:"key"});console.log("Settings store created")}}if(u<2&&(console.log("Upgrading to version 2: Removing URL uniqueness constraint"),e.objectStoreNames.contains(l.ARTICLES))){let t=r.target.transaction.objectStore(l.ARTICLES);t.indexNames.contains("url")&&t.deleteIndex("url"),t.createIndex("url","url",{unique:!1}),console.log("URL index updated to non-unique")}}})}async function h(){return await p()}async function d(n){let s=await h();return new Promise((o,r)=>{let e=s.transaction([l.SETTINGS],"readonly"),t=e.objectStore(l.SETTINGS).get(n);t.onsuccess=a=>{let c=a.target.result;o(c?c.value:null)},t.onerror=a=>{console.error(`Error getting setting "${n}":`,a.target.error),r(a.target.error)},e.oncomplete=()=>{s.close()}})}function i(n,s){let o=document.getElementById("statusMessage");o.textContent=n,o.className=`status-message ${s}`,o.style.display="block",setTimeout(()=>{o.style.display="none"},3e3)}async function f(n){try{let s=await chrome.tabs.sendMessage(n,{action:"PING"});return console.log("Content script ping response:",s),s&&s.status==="PONG"}catch(s){return console.warn("Content script ping failed:",s),!1}}async function w(n){console.log("Starting article extraction with fallbacks for tab",n);try{let s=chrome.tabs.sendMessage(n,{action:"EXTRACT_ARTICLE"}),o=new Promise((e,u)=>setTimeout(()=>u(new Error("Article extraction timed out")),15e3)),r=await Promise.race([s,o]);if(r&&r.text&&r.text.length>=100)return console.log("Successfully extracted article with normal method"),r;throw new Error((r==null?void 0:r.error)||"Extracted content too short or empty")}catch(s){console.warn("Primary extraction failed:",s),console.log("Trying fallback extraction via background script...");try{let o=await chrome.runtime.sendMessage({action:"EXTRACT_ARTICLE_FALLBACK",tabId:n});if(o&&o.text&&o.text.length>=100)return console.log("Successfully extracted article with fallback method"),o;throw new Error("Fallback extraction failed to get substantial content")}catch(o){throw console.error("Fallback extraction also failed:",o),new Error("Failed to extract article content after multiple attempts")}}}document.addEventListener("DOMContentLoaded",async()=>{console.log("Extension popup opened, initializing...");let n=document.getElementById("saveArticleBtn"),s=document.getElementById("showArticlesBtn"),o=document.getElementById("optionsLink");console.log("Buttons found:",{saveArticleBtn:!!n,showArticlesBtn:!!s,optionsLink:!!o}),await y(),n&&n.addEventListener("click",async()=>{var r;console.log("Save Article button clicked");try{console.log("Save button clicked"),n.disabled=!0,n.innerHTML='<span class="icon">\u23F3</span>Saving...';let[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e){i("No active tab found","error");return}if(console.log("Current tab:",e.id,e.url),["chrome://","chrome-extension://","about:","file:","chrome.google.com","addons.mozilla.org"].some(c=>e.url.startsWith(c))){i(`Cannot extract from ${e.url}. Please try with a regular web page.`,"error");return}i("Preparing extraction...","info");try{await chrome.scripting.executeScript({target:{tabId:e.id},files:["contentScript.js"]}),console.log("Content script injected successfully"),await new Promise(g=>setTimeout(g,500)),await f(e.id)||console.warn("Content script not responding to ping test")}catch(c){if(console.error("Content script injection failed:",c),c.message.includes("Cannot access contents of the page")){i("Cannot access page content. Try with a regular web page.","error");return}}i("Extracting article content...","info");let t;try{t=await w(e.id)}catch(c){console.error("All extraction attempts failed:",c),i("Failed to extract article. Please try a different page.","error");return}if(console.log("Extracted article data:",{title:t==null?void 0:t.title,textLength:((r=t==null?void 0:t.text)==null?void 0:r.length)||0}),!t||!t.text||t.text.length<100){i("No article text found or text too short. Try with a longer article.","error");return}t.url=e.url,i("Saving article...","info");let a=await chrome.runtime.sendMessage({action:"SAVE_ARTICLE",payload:t});console.log("Response from background script:",a),a!=null&&a.success?i("Article saved successfully!","success"):(console.error("Error details:",a),i("Failed to save the article: "+((a==null?void 0:a.error)||"Unknown error"),"error"))}catch(e){console.error("Error in save article flow:",e),i(e.message||"Failed to process the article.","error")}finally{n.disabled=!1,n.innerHTML='<span class="icon">\u{1F4DD}</span>Save This Article'}}),s&&s.addEventListener("click",async()=>{console.log("Show Articles button clicked");let r=chrome.runtime.getURL("articles.html");await chrome.tabs.create({url:r}),window.close()}),o&&o.addEventListener("click",()=>{chrome.runtime.openOptionsPage?chrome.runtime.openOptionsPage():window.open(chrome.runtime.getURL("options.html"))})});async function y(){try{let n=await d("host_voice")||"echo",s=document.getElementById("hostVoiceDisplay");if(s){let e={alloy:"Esha",echo:"Hari",fable:"Mira",onyx:"Tej",nova:"Leela",shimmer:"Veena"};s.textContent=e[n]||n}let o=await d("cohost_voice")||"nova",r=document.getElementById("cohostVoiceDisplay");if(r){let e={alloy:"Esha",echo:"Hari",fable:"Mira",onyx:"Tej",nova:"Leela",shimmer:"Veena"};r.textContent=e[o]||o}}catch(n){console.error("Error loading voice settings:",n)}}})();
